#!/bin/sh
set -o errexit -o nounset -o pipefail

exec > /var/log/late-commands-stdout
exec 2> /var/log/late-commands-stderr

/preseed-lib/unattended-upgrades
/preseed-lib/iptables-ssh-only
/preseed-lib/splat-sshd-config
/preseed-lib/exim4

cat > /target/etc/aliases <<EOF
*: dev-null@localhost.localdomain
EOF

cat > /target/etc/ntp.conf <<EOF
driftfile /var/lib/ntp/ntp.drift

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

server ntp.ovh.net

restrict -4 kod notrap nomodify nopeer noquery
restrict -6 kod notrap nomodify nopeer noquery

restrict 127.0.0.1 notrap nomodify nopeer
restrict ::1       notrap nomodify nopeer
EOF

chown root:root /target/etc/ntp.conf
chmod 644 /target/etc/ntp.conf

mkdir -m 700 /target/root/.ssh
install -o root -g root -m 644 /.ssh/authorized_keys /target/root/.ssh/

mkdir /target/usr/local/lib/simple-kvm
# It will be root:staff g+s by default
chown root:root /target/usr/local/lib/simple-kvm
chmod 755 /target/usr/local/lib/simple-kvm

in-target git clone https://github.com/danielrichman/simple-kvm /usr/local/lib/simple-kvm
cp /target/usr/local/lib/simple-kvm/example-config.json /target/etc/guests.json
cp /target/usr/local/lib/simple-kvm/sysctl.conf         /target/etc/sysctl.conf
ln -s /usr/local/lib/simple-kvm/guest-manager /target/usr/local/bin
ln -s /usr/local/lib/simple-kvm/random-mac    /target/usr/local/bin

# raid monitoring
